# 🔐 会话管理说明

## 概述

从 v1.1.0 开始，项目支持自动保存和加载浏览器会话状态，首次登录后无需重复登录。

---

## 🎯 工作原理

### 首次运行

1. 启动浏览器
2. 打开 Google AI Studio
3. 检测到未登录状态
4. 显示登录提示
5. 等待用户手动登录
6. 登录成功后自动保存会话
7. 继续执行任务

### 后续运行

1. 启动浏览器
2. 自动加载已保存的会话
3. 打开 Google AI Studio
4. 已登录状态，直接继续
5. 无需重复登录

---

## 📁 会话文件

### 保存位置

```
.browser_session/
└── state.json  # 会话状态文件
```

### 文件说明

- **state.json**: 包含 cookies、localStorage 等会话信息
- 文件自动创建和更新
- 已添加到 `.gitignore`，不会提交到版本控制

---

## 🛠️ 会话管理

### 查看会话

```bash
# 检查会话文件是否存在
ls -la .browser_session/

# 查看会话文件大小
du -h .browser_session/state.json
```

### 清除会话

**方式1：使用脚本（推荐）**

```bash
python clear_session.py
```

**方式2：手动删除**

```bash
rm -rf .browser_session/
```

### 何时需要清除会话

- ✅ 需要切换 Google 账号
- ✅ 会话过期或失效
- ✅ 遇到登录相关问题
- ✅ 测试首次登录流程

---

## 🔍 登录检测

### 自动检测

脚本会自动检测以下登录状态：

1. **未登录标志**
   - "Sign in" 按钮
   - "登录" 按钮
   - "Login" 按钮

2. **已登录标志**
   - 没有登录按钮
   - 可以正常访问功能

### 手动确认

如果自动检测不准确，可以：

1. 查看浏览器窗口
2. 确认是否已登录
3. 如未登录，手动登录
4. 脚本会自动继续

---

## 📝 登录流程

### 首次登录提示

```
============================================================
🔐 请在浏览器中完成登录
============================================================
1. 请登录你的 Google 账号
2. 完成必要的授权
3. 登录完成后，脚本会自动继续
4. 会话将被保存，下次无需重复登录
============================================================
```

### 等待时间

- 最长等待：5 分钟（300 秒）
- 检查间隔：5 秒
- 每 30 秒显示一次进度

### 登录成功

```
✅ 登录成功！
💾 会话状态已保存
```

---

## 🔧 配置选项

### 无头模式

**注意**：无头模式下无法手动登录！

```python
# config.py
HEADLESS = False  # 必须为 False 才能手动登录
```

### 会话保存

会话在以下时机自动保存：

1. 登录成功后
2. 关闭浏览器前
3. 任务完成后

---

## 🐛 故障排除

### 问题1：会话加载失败

**现象**：
```
⚠️ 加载会话失败: xxx，将创建新会话
```

**原因**：
- 会话文件损坏
- 会话已过期
- 浏览器版本更新

**解决方案**：
```bash
# 清除会话重新登录
python clear_session.py
```

### 问题2：自动登录失败

**现象**：
- 加载了会话但仍需要登录
- 页面显示登录按钮

**原因**：
- 会话已过期
- Google 安全策略要求重新登录

**解决方案**：
```bash
# 清除会话重新登录
python clear_session.py
```

### 问题3：登录检测不准确

**现象**：
- 已登录但脚本认为未登录
- 未登录但脚本认为已登录

**原因**：
- 页面结构变化
- 选择器不匹配

**解决方案**：
1. 查看浏览器窗口确认实际状态
2. 如需要，手动登录
3. 更新 `video_automation.py` 中的登录检测逻辑

### 问题4：无法保存会话

**现象**：
```
❌ 保存会话失败: xxx
```

**原因**：
- 目录权限问题
- 磁盘空间不足

**解决方案**：
```bash
# 检查目录权限
ls -la .browser_session/

# 手动创建目录
mkdir -p .browser_session
chmod 755 .browser_session
```

---

## 🔒 安全说明

### 会话文件安全

- ✅ 会话文件包含登录凭证
- ✅ 已添加到 `.gitignore`
- ✅ 不会提交到版本控制
- ✅ 仅保存在本地

### 安全建议

1. **不要分享会话文件**
   - 会话文件包含登录信息
   - 可能被用于未授权访问

2. **定期清除会话**
   - 长时间不使用时清除会话
   - 切换账号时清除会话

3. **保护本地文件**
   - 确保计算机安全
   - 使用文件系统权限保护

4. **使用专用账号**
   - 建议使用专门的 Google 账号
   - 不要使用主要账号

---

## 📊 会话生命周期

```
首次运行
  ↓
启动浏览器
  ↓
检查会话文件 → 不存在
  ↓
打开 AI Studio
  ↓
检测登录状态 → 未登录
  ↓
等待用户登录
  ↓
登录成功
  ↓
保存会话 → 创建 state.json
  ↓
继续任务
  ↓
关闭浏览器 → 再次保存会话

---

后续运行
  ↓
启动浏览器
  ↓
检查会话文件 → 存在
  ↓
加载会话 → 读取 state.json
  ↓
打开 AI Studio
  ↓
检测登录状态 → 已登录
  ↓
直接继续任务
  ↓
关闭浏览器 → 更新会话
```

---

## 💡 最佳实践

### 1. 首次使用

```bash
# 1. 运行程序
python video_automation.py

# 2. 等待浏览器打开
# 3. 手动登录 Google 账号
# 4. 等待脚本自动继续
```

### 2. 日常使用

```bash
# 直接运行，自动登录
python video_automation.py
```

### 3. 切换账号

```bash
# 1. 清除会话
python clear_session.py

# 2. 重新运行
python video_automation.py

# 3. 登录新账号
```

### 4. 故障排查

```bash
# 1. 清除会话
python clear_session.py

# 2. 重新运行
python video_automation.py

# 3. 重新登录
```

---

## 🎓 技术细节

### Playwright Storage State

使用 Playwright 的 `storage_state` 功能：

```python
# 保存会话
context.storage_state(path="state.json")

# 加载会话
context = browser.new_context(
    storage_state="state.json"
)
```

### 会话内容

`state.json` 包含：

- **cookies**: HTTP cookies
- **localStorage**: 本地存储
- **sessionStorage**: 会话存储
- **origins**: 来源信息

### 自动保存时机

1. **登录成功后**
   ```python
   if self.check_login_status():
       self.save_session()
   ```

2. **关闭浏览器前**
   ```python
   def close_browser(self):
       self.save_session()
   ```

---

## 📚 相关文档

- [开始使用.md](开始使用.md) - 快速上手
- [使用指南.md](使用指南.md) - 详细教程
- [快速参考.md](快速参考.md) - 命令速查

---

## 🎉 总结

会话管理功能让你：

- ✅ 首次登录后无需重复登录
- ✅ 节省时间，提高效率
- ✅ 自动保存和加载会话
- ✅ 简单的会话管理工具

**开始使用**：直接运行 `python video_automation.py`，首次登录后会自动保存会话！

---

**版本**: v1.1.0  
**更新日期**: 2024-12-05
