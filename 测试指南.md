# 🧪 测试指南

快速测试和验证自动化功能的指南。

---

## 📋 测试清单

### ✅ 基础测试

- [ ] 浏览器连接测试
- [ ] 视频上传流程测试
- [ ] 发送提示词流程测试 ⭐ 新增
- [ ] 菜单关闭功能验证
- [ ] 完整流程测试

---

## 🚀 测试脚本

### 1. 测试浏览器连接

**脚本**: `test_connection.py`

**用途**: 验证浏览器是否能正常启动和访问 AI Studio

**运行**:
```bash
python test_connection.py
```

**预期结果**:
- ✅ 浏览器成功启动
- ✅ 成功访问 AI Studio
- ✅ 页面正常加载

---

### 2. 测试视频上传流程

**脚本**: `test_upload.py`

**用途**: 测试完整的视频上传流程，包括菜单关闭

**运行**:
```bash
python test_upload.py
```

**测试步骤**:
1. 启动浏览器
2. 访问 AI Studio
3. 等待用户登录
4. 点击添加按钮
5. 点击 Upload File
6. 使用 file chooser 上传文件
7. 关闭浮窗菜单
8. 等待上传完成

**预期结果**:
```
🧪 测试视频上传流程
============================================================
1️⃣ 启动浏览器...
2️⃣ 访问 AI Studio...

按 Enter 继续测试上传流程...

3️⃣ 开始测试上传流程...
   a) 查找添加按钮...
   ✅ 找到添加按钮
   ✅ 已点击添加按钮
   b) 查找 Upload File 按钮...
   ✅ 找到 Upload File 按钮
   c) 测试 file chooser...
   ✅ 已点击 Upload File 按钮
   ✅ 已选择文件: test.mp4
   d) 关闭浮窗菜单...
   ✅ 已按 Escape 键关闭菜单
   
   ⏳ 等待上传...
   ✅ 上传流程完成

✅ 测试完成！
```

---

### 3. 测试发送提示词流程

**脚本**: `test_send_prompt.py`

**用途**: 测试发送提示词的完整流程，验证按钮状态检测

**运行**:
```bash
python test_send_prompt.py
```

**测试步骤**:
1. 启动浏览器
2. 访问 AI Studio
3. 等待用户登录
4. 查找输入框
5. 填入测试提示词
6. 查找 Run 按钮
7. 检查按钮初始状态
8. 等待按钮可用
9. 点击发送
10. 验证发送成功

**预期结果**:
```
🧪 测试发送提示词流程
============================================================
3️⃣ 查找输入框...
   ✅ 找到输入框

4️⃣ 填入测试提示词...
   ✅ 已填入: 请分析这个内容

5️⃣ 查找 Run 按钮...
   ✅ 找到 Run 按钮

6️⃣ 检查按钮初始状态...
   📊 按钮可见: True
   📊 aria-disabled: true
   ⚠️ 按钮当前不可用

7️⃣ 等待按钮可用...
   ✅ 按钮已可用（等待了 3.5 秒）

8️⃣ 点击 Run 按钮...
   ✅ 已点击 Run 按钮

9️⃣ 验证发送成功...
   ✅ 发送成功！AI 正在处理

✅ 测试完成！
```

---

### 4. 验证菜单关闭功能

**脚本**: `verify_menu_close.py`

**用途**: 专门验证菜单关闭功能是否正常工作

**运行**:
```bash
python verify_menu_close.py
```

**验证内容**:
1. ✅ 点击添加按钮
2. ✅ 检查菜单是否显示
3. ✅ 按 Escape 键关闭菜单
4. ✅ 验证菜单是否关闭
5. ✅ 检查 Run 按钮状态
6. ✅ 检查按钮是否可点击

**预期结果**:
```
🔍 验证菜单关闭功能
============================================================
3️⃣ 点击添加按钮...
   ✅ 已点击添加按钮

4️⃣ 检查菜单状态...
   ✅ 菜单已显示

5️⃣ 关闭菜单...
   ✅ 已按 Escape 键

6️⃣ 验证菜单是否关闭...
   ✅ 菜单已关闭

7️⃣ 检查 Run 按钮状态...
   ✅ Run 按钮可见
   ✅ Run 按钮可用
   ✅ Run 按钮可点击（未被遮挡）

✅ 验证完成！
```

---

### 5. 完整流程测试

**脚本**: `video_automation.py`

**用途**: 运行完整的自动化流程

**运行**:
```bash
python video_automation.py
```

**测试内容**:
- 读取视频列表
- 初始化浏览器
- 打开 AI Studio
- 等待用户确认
- 上传视频
- 执行 25 步对话
- 保存输出
- 合并数据

---

## 🔍 验证要点

### 菜单关闭验证

#### 检查点 1: 菜单是否显示

```python
upload_button = page.locator('button[aria-label="Upload File"]')
if upload_button.is_visible():
    print("✅ 菜单已显示")
```

#### 检查点 2: 菜单是否关闭

```python
page.keyboard.press("Escape")
time.sleep(0.5)

if not upload_button.is_visible(timeout=1000):
    print("✅ 菜单已关闭")
```

#### 检查点 3: Run 按钮是否可用

```python
run_button = page.locator('button[aria-label="Run"]')

# 检查可见性
if run_button.is_visible():
    print("✅ Run 按钮可见")

# 检查是否可用
is_disabled = run_button.get_attribute('aria-disabled')
if is_disabled != 'true':
    print("✅ Run 按钮可用")

# 检查是否可点击
try:
    run_button.click(timeout=1000, trial=True)
    print("✅ Run 按钮可点击")
except:
    print("❌ Run 按钮不可点击")
```

---

## 🐛 常见问题

### 问题 1: 找不到测试文件

**错误**:
```
⚠️ 测试文件不存在: test.mp4
```

**解决方案**:
1. 在桌面或下载文件夹放置一个测试视频
2. 或修改脚本中的文件路径

```python
test_file = Path("/path/to/your/test.mp4")
```

### 问题 2: 菜单未关闭

**症状**:
```
❌ 菜单仍然显示（未关闭）
```

**解决方案**:
1. 检查是否等待了足够时间
2. 尝试增加延迟
3. 使用备用方法

```python
# 增加延迟
time.sleep(0.5)  # 从 0.3 改为 0.5
page.keyboard.press("Escape")
```

### 问题 3: Run 按钮不可点击

**症状**:
```
❌ Run 按钮不可点击（可能被遮挡）
```

**解决方案**:
1. 确认菜单已关闭
2. 等待更长时间
3. 检查是否有其他元素遮挡

---

## 📊 测试报告

### 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 浏览器连接 | ✅ | 正常 |
| 视频上传 | ✅ | 正常 |
| 菜单关闭 | ✅ | 正常 |
| Run 按钮可用 | ✅ | 正常 |
| 完整流程 | ✅ | 正常 |

### 性能指标

| 指标 | 值 |
|------|-----|
| 浏览器启动时间 | ~3 秒 |
| 页面加载时间 | ~2 秒 |
| 菜单关闭时间 | ~0.5 秒 |
| 文件上传时间 | ~15 秒 |

---

## 💡 测试技巧

### 1. 使用截图

```python
page.screenshot(path="test_result.png")
```

### 2. 查看日志

```bash
tail -f automation.log
```

### 3. 调试模式

```python
# 在 config.py 中设置
DEBUG_MODE = True
LOG_LEVEL = "DEBUG"
```

### 4. 慢速执行

```python
# 添加更多等待时间
time.sleep(2)
```

---

## 🎯 测试建议

### 首次测试

1. ✅ 先运行 `test_connection.py`
2. ✅ 再运行 `test_upload.py`
3. ✅ 然后运行 `verify_menu_close.py`
4. ✅ 最后运行完整流程

### 日常测试

1. ✅ 运行 `verify_menu_close.py` 快速验证
2. ✅ 有问题时运行 `test_upload.py` 详细测试

### 问题排查

1. ✅ 查看日志文件
2. ✅ 查看截图
3. ✅ 运行验证脚本
4. ✅ 逐步调试

---

## 📝 测试记录

### 测试日期: ___________

#### 测试环境
- 操作系统: ___________
- Python 版本: ___________
- Playwright 版本: ___________
- Chrome 版本: ___________

#### 测试结果
- [ ] 浏览器连接测试
- [ ] 视频上传流程测试
- [ ] 菜单关闭功能验证
- [ ] 完整流程测试

#### 问题记录
1. ___________
2. ___________
3. ___________

#### 备注
___________

---

**更新日期**: 2024-12-05  
**版本**: v1.3.3
