# 视频处理自动化 - 使用指南

## 📋 目录

1. [快速开始](#快速开始)
2. [详细配置](#详细配置)
3. [常见问题](#常见问题)
4. [高级用法](#高级用法)

---

## 🚀 快速开始

### 第一步：安装依赖

```bash
# 方式1：使用安装脚本（推荐）
chmod +x setup.sh
./setup.sh

# 方式2：手动安装
pip install -r requirements.txt
playwright install chromium
```

### 第二步：准备文件

确保以下文件和目录存在：

```
assets/
├── Process_Folder/
│   ├── prompts.xlsx          # 提示词文件
│   └── videos/
│       ├── VideoList.csv     # 视频列表
│       └── *.mp4             # 视频文件
└── vidoes/
    ├── clips.xlsx            # 最终输出（自动生成）
    └── process_video.py      # 最终处理脚本
```

### 第三步：运行脚本

```bash
# 方式1：使用启动脚本
chmod +x run.sh
./run.sh

# 方式2：直接运行
python video_automation.py
```

---

## ⚙️ 详细配置

### 配置文件说明

编辑 `config.py` 来调整各项参数：

#### 1. 路径配置

```python
# 默认路径（通常不需要修改）
PROCESS_FOLDER = BASE_DIR / "assets" / "Process_Folder"
VIDEOS_FOLDER = PROCESS_FOLDER / "videos"
```

#### 2. 浏览器配置

```python
HEADLESS = False  # True=无头模式，False=显示浏览器
BROWSER_TIMEOUT = 60000  # 浏览器超时时间（毫秒）
```

#### 3. 等待时间配置

```python
WAIT_AFTER_UPLOAD = 15  # 上传视频后等待时间（秒）
WAIT_AFTER_SEND = 3     # 发送提示词后等待时间（秒）
WAIT_FOR_RESPONSE = 10  # 等待 AI 响应时间（秒）
```

**💡 提示**：如果视频文件较大或网络较慢，建议增加 `WAIT_AFTER_UPLOAD` 的值。

#### 4. 页面选择器配置

如果 Google AI Studio 页面结构发生变化，需要更新选择器：

```python
SELECTORS = {
    # 文件上传 - 两步流程
    'add_button': 'button[iconname="add_circle"]',  # 添加按钮
    'upload_file_button': 'button[aria-label="Upload File"]',  # Upload File 按钮
    'file_input': 'input[data-test-upload-file-input]',  # 文件输入框
    
    'input_box': 'textarea[placeholder*="Enter"]',
    'send_button': 'button[aria-label*="Send"]',
    # ... 更多选择器
}
```

**上传视频流程**：
1. 点击添加按钮（add_circle 图标）
2. 在弹出的菜单中点击 "Upload File"
3. 选择视频文件上传

**如何找到正确的选择器？**

1. 在浏览器中打开 Google AI Studio
2. 按 F12 打开开发者工具
3. 点击元素选择器（左上角箭头图标）
4. 点击页面上的目标元素
5. 在开发者工具中查看元素的属性
6. 更新 `config.py` 中的选择器

---

## 📝 prompts.xlsx 文件格式

### 基本格式

提示词文件应包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| 文件名称 | 视频文件名 | video1.mp4 |
| 视频时长 | 视频时长 | 0:12:57 |
| 步骤1 | 第1个提示词 | 请分析这个视频... |
| 步骤2 | 第2个提示词 | 提取关键场景... |
| ... | ... | ... |
| 步骤25 | 第25个提示词 | 生成最终报告... |

### 示例

```
| 文件名称 | 视频时长 | 步骤1 | 步骤2 | ... | 步骤25 |
|----------|----------|-------|-------|-----|--------|
| video.mp4| 0:12:57  | 分析  | 提取  | ... | 报告   |
```

---

## 🔍 常见问题

### Q1: 找不到上传按钮

**原因**：页面选择器可能已更改

**解决方案**：
1. 运行测试脚本查看页面结构：
   ```bash
   python test_connection.py
   ```
2. 查看生成的截图 `test_screenshot.png`
3. 使用浏览器开发者工具找到正确的选择器
4. 更新 `config.py` 中的 `SELECTORS['file_upload']`

### Q2: 视频上传失败

**可能原因**：
- 视频文件不存在
- 文件太大
- 网络问题
- 等待时间不够

**解决方案**：
1. 检查视频文件路径是否正确
2. 增加 `config.py` 中的 `WAIT_AFTER_UPLOAD` 值
3. 检查网络连接
4. 查看日志文件 `automation.log` 了解详细错误

### Q3: AI 响应超时

**解决方案**：
1. 增加 `config.py` 中的 `WAIT_FOR_RESPONSE` 值
2. 检查网络连接
3. 确认 Google AI Studio 服务正常

### Q4: Content blocked 无法自动处理

**解决方案**：
1. 检查 `config.py` 中的 `SELECTORS['content_blocked']`
2. 查看截图文件了解实际的错误提示文本
3. 更新检测逻辑

### Q5: 关于登录和确认

**默认使用系统 Chrome（推荐）**

- ✅ 使用本机已安装的 Chrome 浏览器
- ✅ 使用默认用户配置
- ✅ 如果 Chrome 已登录 Google 账号，直接可用
- ✅ 打开页面后等待用户确认

**用户确认流程**：

1. 脚本打开 AI Studio
2. 显示确认提示：
   ```
   👤 请确认以下操作
   1. 确保已登录 Google 账号
   2. 进入 AI Studio 对话界面
   3. 准备好开始处理视频
   
   ✅ 完成上述操作后，按 Enter 键继续...
   ```
3. 你在浏览器中完成登录和进入对话界面
4. 按 Enter 键，脚本继续处理

**跳过用户确认**：

如果不想每次确认，可以设置：
```python
# config.py
WAIT_USER_CONFIRMATION = False
```

此时脚本会自动检测登录状态并继续。

**使用 Chromium 浏览器**：

如果不想使用系统 Chrome，可以设置：
```python
# config.py
USE_SYSTEM_CHROME = False
```

此时会使用 Playwright 的 Chromium：
- 首次需要手动登录
- 会话保存在 `.browser_session/` 目录
- 后续运行自动加载会话

---

## 🎯 高级用法

### 1. 无头模式运行

适合在服务器上运行，不显示浏览器窗口：

```python
# 修改 config.py
HEADLESS = True
```

或者在代码中：

```python
processor = VideoProcessor()
processor.run(headless=True)
```

### 2. 只处理特定视频

修改 `VideoList.csv`，只保留需要处理的视频。

### 3. 调试模式

启用调试模式可以保存更多截图和日志：

```python
# 修改 config.py
DEBUG_MODE = True
LOG_LEVEL = "DEBUG"
SAVE_SCREENSHOTS = True
```

### 4. 自定义保存步骤

默认保存步骤 23 和 25 的输出，可以修改：

```python
# 修改 config.py
SAVE_STEPS = [5, 10, 15, 23, 25]  # 保存更多步骤
```

### 5. 批量处理策略

对于大量视频，建议：

1. **分批处理**：将视频分成多个批次
2. **增加休息时间**：避免触发 API 限制
   ```python
   WAIT_BETWEEN_VIDEOS = 10  # 增加到 10 秒
   ```
3. **监控日志**：实时查看 `automation.log`
   ```bash
   tail -f automation.log
   ```

### 6. 错误恢复

如果脚本中断，可以：

1. 查看日志文件了解中断位置
2. 从 `VideoList.csv` 中删除已处理的视频
3. 重新运行脚本继续处理

---

## 📊 输出文件说明

### 1. 步骤输出文件

每个视频会生成一个文件夹：

```
assets/Process_Folder/[视频名称]/
├── step_23_output.xlsx  # 步骤23的输出
└── step_25_output.xlsx  # 步骤25的输出
```

### 2. 合并文件

所有视频处理完成后，会生成：

```
assets/vidoes/clips.xlsx  # 合并所有输出
```

### 3. 日志文件

```
automation.log  # 详细的运行日志
```

### 4. 截图文件（如果启用）

```
screenshots/
├── ai_studio_opened_20231205_120000.png
├── video_uploaded_20231205_120030.png
├── step_1_output_20231205_120100.png
└── ...
```

---

## 🛠️ 故障排除流程

1. **查看日志**
   ```bash
   cat automation.log
   ```

2. **运行测试脚本**
   ```bash
   python test_connection.py
   ```

3. **检查截图**
   - 查看 `screenshots/` 目录
   - 找到出错时的截图

4. **手动测试**
   - 设置 `HEADLESS = False`
   - 观察浏览器操作过程

5. **更新选择器**
   - 使用开发者工具
   - 更新 `config.py`

---

## 📞 获取帮助

如果遇到问题：

1. 查看日志文件 `automation.log`
2. 查看截图文件了解页面状态
3. 运行测试脚本 `python test_connection.py`
4. 检查配置文件 `config.py`

---

## 📝 最佳实践

1. **首次运行**：使用小批量视频测试
2. **网络稳定**：确保网络连接稳定
3. **定期备份**：备份输出文件
4. **监控日志**：实时查看运行状态
5. **合理配置**：根据实际情况调整等待时间

---

## 🎉 完成！

现在你已经掌握了视频处理自动化工具的使用方法。祝你使用愉快！
