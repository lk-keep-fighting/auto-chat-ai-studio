# 🌐 浏览器配置说明

## 概述

从 v1.2.0 开始，项目支持使用系统安装的 Chrome 浏览器和默认用户配置，无需重复登录。

---

## 🎯 两种浏览器模式

### 模式1：系统 Chrome（推荐）⭐

**默认模式，强烈推荐！**

```python
# config.py
USE_SYSTEM_CHROME = True  # 默认值
```

**优点**：
- ✅ 使用本机已安装的 Chrome 浏览器
- ✅ 使用默认用户配置（Profile）
- ✅ 已登录的 Google 账号直接可用
- ✅ 无需重复登录
- ✅ 更稳定可靠
- ✅ 与日常使用的 Chrome 一致

**适用场景**：
- 日常使用（推荐）
- Chrome 已登录 Google 账号
- 需要使用 Chrome 扩展
- 需要使用已保存的密码

### 模式2：Chromium 浏览器

**备选模式**

```python
# config.py
USE_SYSTEM_CHROME = False
```

**特点**：
- 使用 Playwright 自带的 Chromium
- 独立的浏览器环境
- 需要手动登录（首次）
- 会话保存在 `.browser_session/`

**适用场景**：
- 需要隔离的浏览器环境
- 系统未安装 Chrome
- 需要使用特定版本的浏览器
- 测试和开发

---

## 📁 Chrome 用户数据目录

### macOS

```
~/Library/Application Support/Google/Chrome/Default
```

### Windows

```
C:\Users\[用户名]\AppData\Local\Google\Chrome\User Data\Default
```

### Linux

```
~/.config/google-chrome/Default
```

---

## 🔧 配置方法

### 使用系统 Chrome（推荐）

**config.py**：
```python
USE_SYSTEM_CHROME = True
HEADLESS = False  # 必须为 False
```

**运行**：
```bash
python video_automation.py
```

**效果**：
- 打开系统 Chrome
- 使用默认用户配置
- 已登录账号直接可用

### 使用 Chromium

**config.py**：
```python
USE_SYSTEM_CHROME = False
HEADLESS = False
```

**运行**：
```bash
python video_automation.py
```

**效果**：
- 打开 Chromium
- 独立的浏览器环境
- 首次需要登录

---

## 🚀 使用流程

### 系统 Chrome 模式

#### 首次运行（Chrome 已登录）

```bash
$ python video_automation.py

# 输出：
# 🌐 使用系统 Chrome 浏览器
# 📁 用户数据目录: /Users/xxx/Library/Application Support/Google/Chrome/Default
# ✅ 系统 Chrome 已启动，使用默认用户配置
# 🌐 正在打开 https://aistudio.google.com/
# ✅ 已登录状态
# ✅ AI Studio 已打开
# ... 继续处理
```

#### 首次运行（Chrome 未登录）

```bash
$ python video_automation.py

# 输出：
# 🌐 使用系统 Chrome 浏览器
# ✅ 系统 Chrome 已启动
# 🌐 正在打开 https://aistudio.google.com/
# ⚠️ 检测到未登录状态
# 🔐 需要登录
# 
# ============================================================
# 🔐 请在浏览器中完成登录
# ============================================================

# 在 Chrome 中手动登录后：
# ✅ 登录成功！
# ✅ AI Studio 已打开
# ... 继续处理
```

#### 后续运行

```bash
$ python video_automation.py

# 输出：
# 🌐 使用系统 Chrome 浏览器
# ✅ 系统 Chrome 已启动
# ✅ 已登录状态
# ... 直接继续处理
```

### Chromium 模式

与之前的会话管理方式相同，详见 [会话管理说明.md](会话管理说明.md)

---

## 🔍 自动检测和回退

### 检测逻辑

1. **检查配置**
   ```python
   if USE_SYSTEM_CHROME and not HEADLESS:
       # 尝试使用系统 Chrome
   ```

2. **检查 Chrome 安装**
   - 检查 Chrome 用户数据目录是否存在
   - 检查是否可以启动 Chrome

3. **启动 Chrome**
   - 使用 `channel="chrome"` 启动系统 Chrome
   - 使用 `launch_persistent_context` 加载用户配置

4. **自动回退**
   - 如果启动失败，自动回退到 Chromium
   - 使用会话管理功能

### 回退示例

```bash
$ python video_automation.py

# 输出：
# 🌐 使用系统 Chrome 浏览器
# ⚠️ 启动系统 Chrome 失败: xxx
# 将使用 Chromium 浏览器
# 📝 使用 Chromium 浏览器
# ... 继续使用 Chromium
```

---

## 💡 最佳实践

### 1. 日常使用

**推荐配置**：
```python
USE_SYSTEM_CHROME = True
HEADLESS = False
```

**优点**：
- 使用熟悉的 Chrome
- 无需重复登录
- 最佳用户体验

### 2. 首次使用

**步骤**：
1. 确保 Chrome 已安装
2. 在 Chrome 中登录 Google 账号
3. 运行脚本，自动使用已登录账号

### 3. 多账号切换

**方法1：在 Chrome 中切换**
1. 在 Chrome 中切换到其他账号
2. 运行脚本，使用当前账号

**方法2：使用 Chromium**
```python
USE_SYSTEM_CHROME = False
```
然后使用会话管理功能

### 4. 隔离环境

**需求**：不想影响日常使用的 Chrome

**方法**：
```python
USE_SYSTEM_CHROME = False
```
使用独立的 Chromium 环境

---

## 🐛 故障排除

### 问题1：找不到 Chrome

**现象**：
```
⚠️ 启动系统 Chrome 失败
将使用 Chromium 浏览器
```

**原因**：
- Chrome 未安装
- Chrome 安装在非标准位置

**解决方案**：
1. 安装 Chrome
2. 或使用 Chromium：`USE_SYSTEM_CHROME = False`

### 问题2：Chrome 启动失败

**现象**：
```
⚠️ 启动系统 Chrome 失败: xxx
```

**可能原因**：
- Chrome 正在运行
- 用户数据目录被锁定
- 权限问题

**解决方案**：
1. 关闭所有 Chrome 窗口
2. 重新运行脚本
3. 或使用 Chromium：`USE_SYSTEM_CHROME = False`

### 问题3：无头模式不支持

**现象**：
```
USE_SYSTEM_CHROME = True
HEADLESS = True  # 不支持
```

**原因**：
- 系统 Chrome 不支持无头模式加载用户配置

**解决方案**：
```python
# 方案1：使用有头模式
HEADLESS = False

# 方案2：使用 Chromium
USE_SYSTEM_CHROME = False
HEADLESS = True
```

### 问题4：Chrome 版本不兼容

**现象**：
- Chrome 启动失败
- 功能异常

**解决方案**：
1. 更新 Chrome 到最新版本
2. 更新 Playwright：`pip install -U playwright`
3. 重新安装浏览器：`playwright install chrome`

---

## 🔒 安全说明

### 系统 Chrome 模式

**安全性**：
- ✅ 使用系统 Chrome 的安全机制
- ✅ 登录信息保存在 Chrome 中
- ✅ 与日常使用的 Chrome 一致
- ✅ 受 Chrome 的安全策略保护

**注意事项**：
- 脚本可以访问 Chrome 中的所有数据
- 包括已保存的密码、cookies 等
- 建议在可信环境中运行

### Chromium 模式

**安全性**：
- ✅ 独立的浏览器环境
- ✅ 会话保存在本地文件
- ✅ 不影响系统 Chrome

**注意事项**：
- 会话文件包含登录信息
- 不要分享 `.browser_session/` 目录

---

## 📊 性能对比

| 特性 | 系统 Chrome | Chromium |
|------|-------------|----------|
| 启动速度 | 快 | 快 |
| 内存使用 | 正常 | 正常 |
| 登录方式 | 使用已登录账号 | 需要登录 |
| 会话管理 | Chrome 管理 | 脚本管理 |
| 扩展支持 | ✅ | ❌ |
| 书签同步 | ✅ | ❌ |
| 隔离性 | 低 | 高 |

---

## 🎓 技术细节

### Playwright Channel

使用 `channel="chrome"` 启动系统 Chrome：

```python
browser = playwright.chromium.launch_persistent_context(
    user_data_dir=chrome_user_data_dir,
    channel="chrome",  # 使用系统 Chrome
    headless=False,
)
```

### Persistent Context

使用 `launch_persistent_context` 加载用户配置：

```python
# 加载 Chrome 的 Default 配置
browser = playwright.chromium.launch_persistent_context(
    user_data_dir="/path/to/Chrome/Default",
    channel="chrome",
)
```

### 自动检测

```python
def get_chrome_user_data_dir(self):
    """自动检测 Chrome 用户数据目录"""
    system = platform.system()
    if system == "Darwin":  # macOS
        return "~/Library/Application Support/Google/Chrome"
    elif system == "Windows":
        return "~/AppData/Local/Google/Chrome/User Data"
    elif system == "Linux":
        return "~/.config/google-chrome"
```

---

## 📚 相关文档

- [会话管理说明.md](会话管理说明.md) - Chromium 模式的会话管理
- [使用指南.md](使用指南.md) - 详细使用教程
- [快速参考.md](快速参考.md) - 配置速查

---

## 🎉 总结

### 推荐配置

```python
# config.py
USE_SYSTEM_CHROME = True  # 使用系统 Chrome
HEADLESS = False          # 显示浏览器
```

### 优势

- ✅ 使用熟悉的 Chrome 浏览器
- ✅ 无需重复登录
- ✅ 最佳用户体验
- ✅ 自动回退机制

### 开始使用

```bash
# 确保 Chrome 已登录 Google 账号
# 直接运行
python video_automation.py
```

---

**版本**: v1.2.0  
**更新日期**: 2024-12-05
