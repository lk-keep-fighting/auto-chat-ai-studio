# 测试用例使用指南

## 概述

项目提供了测试工具来验证步骤23和步骤25的数据提取和保存功能。

## 测试工具

### test_step23_25.py

**功能**：测试步骤23（SRT文件）和步骤25（表格数据）的完整流程

**测试内容**：
1. 初始化浏览器
2. 打开 AI Studio
3. 等待用户确认
4. 发送步骤23测试提示词
5. 等待AI响应
6. 提取并保存SRT文件
7. 发送步骤25测试提示词
8. 等待AI响应
9. 提取并保存表格数据
10. 验证保存结果

## 使用方法

### 方法1：使用Shell脚本（推荐）

```bash
./test/test_step23_25.sh
```

或者：

```bash
cd test
./test_step23_25.sh
```

### 方法2：直接运行Python脚本

```bash
python test_step23_25.py
```

## 测试流程

### 1. 启动测试

```bash
./test/test_step23_25.sh
```

### 2. 等待浏览器打开

程序会自动：
- 激活虚拟环境
- 启动浏览器
- 打开 AI Studio

### 3. 用户确认

程序会暂停并显示：

```
请确认以下事项：
1. ✅ 已登录 Google 账号
2. ✅ 已进入 AI Studio 对话界面
3. ✅ 页面加载完成

✅ 确认无误后，按 Enter 键继续测试...
```

确认后按 Enter 继续。

### 4. 测试步骤23

程序会：
1. 发送步骤23测试提示词
2. 等待AI生成2个SRT文件
3. 提取响应数据
4. 保存为SRT文件
5. 验证保存结果

### 5. 测试步骤25

程序会：
1. 发送步骤25测试提示词
2. 等待AI生成表格数据
3. 提取表格数据
4. 保存为Excel文件
5. 验证保存结果

### 6. 查看结果

测试完成后，程序会显示：

```
📊 测试结果汇总
步骤23: ✅ 成功
步骤25: ✅ 成功

🎉 所有测试通过！

📁 输出文件：
  - 步骤23: assets/Process_Folder/test_步骤23_SRT文件/step_23_output_*.srt
  - 步骤25: assets/Process_Folder/test_步骤25_表格数据/step_25_output.xlsx
  - 日志: test_step23_25.log
```

## 输出文件

### 步骤23输出

**位置**：`assets/Process_Folder/test_步骤23_SRT文件/`

**文件**：
- `step_23_output_1.srt` - 第一个SRT文件
- `step_23_output_2.srt` - 第二个SRT文件
- 或 `step_23_output.txt` - 如果未识别为SRT格式

**格式**：标准SRT格式
```
1
00:00:00,000 --> 00:00:03,000
字幕内容...

2
00:00:03,000 --> 00:00:06,000
字幕内容...
```

### 步骤25输出

**位置**：`assets/Process_Folder/test_步骤25_表格数据/`

**文件**：`step_25_output.xlsx`

**格式**：Excel表格
| start | end | folder1 | folder2 | folder3 | music | cover_time | title |
|-------|-----|---------|---------|---------|-------|------------|-------|
| 00:00:00 | 00:00:03 | 故事1 | ... | ... | ... | 00:00:00 | ... |

## 日志文件

**位置**：`test_step23_25.log`

**内容**：
- 详细的测试过程
- 数据提取信息
- 保存结果验证
- 错误信息（如果有）

## 验证v1.8.1修复

### 验证步骤25表格提取

**预期日志**：
```
📊 步骤25：尝试从HTML DOM提取表格数据...
⏳ 等待表格元素出现...
✅ 表格元素已出现
📋 找到 1 个表格，使用最后一个
📋 表头（从thead提取）: ['start', 'end', 'folder1', 'folder2', 'folder3', 'music', 'cover_time', 'title']
📊 从tbody找到 10 行数据
✅ 成功提取 10 行数据
✅ 从DOM提取到 10 行表格数据
```

**验证点**：
- ✅ 表头正确提取
- ✅ 数据行数正确（10行）
- ✅ Excel文件创建成功
- ✅ 数据完整

### 验证步骤23 SRT文件

**预期日志**：
```
📋 找到 2 个标记的SRT文件
✅ 保存SRT文件 1: step_23_output_1.srt (XXX 字符)
✅ 保存SRT文件 2: step_23_output_2.srt (XXX 字符)
✅ 步骤 23 保存了 2 个SRT文件
```

**验证点**：
- ✅ 识别为SRT格式
- ✅ 保存为独立的.srt文件
- ✅ 文件数量正确（2个）
- ✅ 内容格式正确

## 故障排除

### 问题1：步骤25数据为空

**症状**：
```
⚠️ 未找到表格元素
⚠️ 从DOM提取表格失败
📝 提取响应文本，长度: 0 字符
```

**原因**：
- v1.8.0的问题（已在v1.8.1修复）
- 表格选择器不正确

**解决**：
- 确保使用v1.8.1或更高版本
- 检查日志中的表格提取信息

### 问题2：步骤23保存为文本而不是SRT

**症状**：
```
⚠️ 步骤 23 未找到SRT文件内容，保存为文本
✅ 已保存为文本文件: step_23_output.txt
```

**原因**：
- AI返回的格式不是标准SRT格式
- 没有明确的文件标记
- 没有SRT时间戳

**解决**：
1. 查看 `step_23_output.txt` 的内容
2. 检查是否包含时间戳格式
3. 调整提示词，要求明确的SRT格式

### 问题3：浏览器未打开

**症状**：
```
❌ 打开 AI Studio 失败
```

**原因**：
- 浏览器未安装
- 虚拟环境未激活
- Playwright未安装

**解决**：
```bash
# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装Playwright浏览器
playwright install chromium
```

### 问题4：登录失败

**症状**：
- 浏览器打开但未登录
- 需要手动登录

**解决**：
1. 手动登录 Google 账号
2. 进入 AI Studio 对话界面
3. 按 Enter 继续测试

## 测试提示词

### 步骤23提示词

```
步骤23：【角色设定】按内容要求生成2个srt文件的测试数据

【内容要求】
风格：电影解说旁白风格（第三人称，情绪饱满）。
覆盖：旁白内容必须填满计算出的时长，不要留白。

输出要求：
请输出修正后的纯旁白英文 SRT 文件。
格式：标准的 .srt 格式。
所有时间戳必须严格使用 hh:mm:ss,ms 格式（小时:分钟:秒,毫秒），并确保每一个时间戳都完全符合规范。
```

### 步骤25提示词

```
步骤25:按输出格式输出10行测试数据

【输出格式】
请直接输出表格。表头如下：
| start | end | folder1 | folder2 | folder3 | music | cover_time | title |
```

## 调试功能

测试工具包含调试功能：

1. **截图**：在提取数据前截图
   - 文件：`screenshots/before_extract_step23_*.png`
   - 文件：`screenshots/before_extract_step25_*.png`

2. **保存HTML**：保存页面HTML用于分析
   - 文件：`test_output/step23_page.html`
   - 文件：`test_output/step25_page.html`

3. **详细日志**：记录所有操作
   - 文件：`test_step23_25.log`

## 总结

测试用例 `test_step23_25.py` 可以用来验证v1.8.1的修复：

✅ **可以验证**：
- 步骤25表格提取是否成功
- 表头是否正确识别
- 数据行是否完整提取
- Excel文件是否正确保存

✅ **可以验证**：
- 步骤23 SRT文件识别
- 多个SRT文件保存
- 文件格式是否正确

✅ **推荐使用**：
- 在修改代码后运行测试
- 验证修复效果
- 调试数据提取问题

现在你可以运行测试来验证v1.8.1的修复效果！
