# 账号切换调试指南

## 问题诊断

如果账号切换后仍然无法正确识别新账号，请按照以下步骤调试：

---

## 1. 查看日志输出

### 正常的日志应该是这样的：

```
============================================================
🔄 开始切换账号
============================================================
📧 当前账号: liusir2606@gmail.com
1️⃣ 点击账号切换按钮...
✅ 已点击账号切换按钮
2️⃣ 点击切换账号按钮...
✅ 已点击切换账号按钮
3️⃣ 等待跳转到账号切换页面...
✅ 已跳转到 Google 账号切换页面
4️⃣ 选择下一个可用账号...
📊 找到 3 个账号，其中 2 个可用
📋 所有账号: liusir2606@gmail.com, kun.liu@example.com, sam.ji@example.com
🔄 已切换: liusir2606@gmail.com
📧 选择账号: kun.liu@example.com
✅ 已点击账号
5️⃣ 等待返回 AI Studio...
✅ 已返回 AI Studio
6️⃣ 验证账号切换...
✅ 当前账号: kun.liu@example.com  ← 应该是新账号
✅ 账号切换成功: liusir2606@gmail.com → kun.liu@example.com
============================================================
✅ 账号切换完成
📊 已切换账号数: 2
============================================================
```

### 如果看到这样的日志，说明有问题：

```
6️⃣ 验证账号切换...
✅ 当前账号: liusir2606@gmail.com  ← 还是旧账号！
⚠️ 账号未改变，仍然是: liusir2606@gmail.com
```

---

## 2. 检查截图

程序会自动保存截图到 `screenshots/` 目录：

### 关键截图：

1. **account_menu_opened_*.png**
   - 点击账号按钮后的菜单
   - 检查是否显示当前账号

2. **google_account_page_*.png**
   - Google 账号选择页面
   - 检查是否显示所有可用账号

3. **account_switched_*.png**
   - 切换完成后的页面
   - 检查账号按钮是否显示新账号

### 如何检查：

```bash
# 查看最新的截图
ls -lt screenshots/ | head -10

# 打开截图
open screenshots/account_switched_*.png
```

---

## 3. 启用调试日志

### 修改 config.py：

```python
# 修改日志级别
LOG_LEVEL = "DEBUG"  # 从 INFO 改为 DEBUG
```

### 重新运行程序：

```bash
python video_automation.py
```

### 查看详细日志：

```bash
# 实时查看日志
tail -f automation.log

# 搜索账号相关日志
grep "账号" automation.log
grep "检测到当前账号" automation.log
```

---

## 4. 手动测试账号识别

### 在程序运行时，打开浏览器控制台：

1. 按 `F12` 打开开发者工具
2. 切换到 Console 标签
3. 运行以下命令：

```javascript
// 查找账号按钮
const button = document.querySelector('button.account-switcher-button');
console.log('按钮:', button);

// 查看按钮文本
console.log('按钮文本:', button.innerText);

// 查看按钮 HTML
console.log('按钮 HTML:', button.innerHTML);

// 查看按钮属性
console.log('aria-label:', button.getAttribute('aria-label'));
console.log('title:', button.getAttribute('title'));

// 查找包含 @ 的元素
const emailSpan = button.querySelector('span');
console.log('邮箱元素:', emailSpan);
console.log('邮箱文本:', emailSpan ? emailSpan.innerText : 'null');
```

### 将输出结果发送给开发者

---

## 5. 增加等待时间

如果网络较慢，可能需要增加等待时间。

### 修改 video_automation.py：

找到 `get_current_account()` 方法，增加等待时间：

```python
def get_current_account(self):
    """获取当前登录的账号（增强版，等待页面更新）"""
    try:
        # 等待页面稳定 - 从 2 秒改为 5 秒
        time.sleep(5)  # ← 修改这里
        
        # ... 其他代码
```

找到 `switch_account()` 方法，增加验证前的等待：

```python
# 等待页面完全加载 - 从 3 秒改为 5 秒
time.sleep(5)  # ← 修改这里
self.take_screenshot("account_switched")

# 验证账号是否切换成功
logger.info("6️⃣ 验证账号切换...")
```

---

## 6. 检查页面元素

### 账号按钮的选择器可能已更改

如果 Google 更新了页面结构，选择器可能失效。

### 查找新的选择器：

1. 在浏览器中打开 AI Studio
2. 右键点击账号按钮 → 检查元素
3. 查看元素的 class、id、属性
4. 更新 `video_automation.py` 中的选择器

```python
# 在 get_current_account() 方法中
account_button_selectors = [
    'button.account-switcher-button',  # 当前选择器
    'button[class*="account-switcher"]',
    # 添加新的选择器
    'button[aria-label*="Account"]',
    'button[data-test-id="account-button"]',
]
```

---

## 7. 临时解决方案：手动选择

如果自动识别仍然失败，程序会提示手动选择：

```
⚠️ 没有找到可用的账号
💡 提示: 所有账号可能都已使用，或需要手动选择

请手动选择一个账号，然后按 Enter 继续...
👉 选择完成后按 Enter:
```

### 操作步骤：

1. 在浏览器中手动点击账号
2. 等待页面加载完成
3. 在终端按 Enter 键
4. 程序会尝试识别新账号

---

## 8. 重置已切换账号记录

如果记录错误，可以重启程序清空记录：

```bash
# 停止程序
Ctrl+C

# 重新启动
python video_automation.py
```

程序重启后，`switched_accounts` 会被清空。

---

## 9. 联系支持

如果以上方法都无法解决问题，请提供以下信息：

### 需要的信息：

1. **日志文件**：
   ```bash
   # 复制最后 100 行日志
   tail -100 automation.log > debug.log
   ```

2. **截图**：
   - `account_menu_opened_*.png`
   - `google_account_page_*.png`
   - `account_switched_*.png`

3. **浏览器控制台输出**：
   - 按照步骤 4 的命令运行
   - 截图或复制输出

4. **系统信息**：
   ```bash
   python --version
   pip show playwright
   uname -a  # macOS/Linux
   ```

5. **问题描述**：
   - 什么时候开始出现问题
   - 是否所有账号都无法识别
   - 是否只有特定账号无法识别

---

## 10. 常见问题

### Q1: 为什么切换后还是旧账号？

**A**: 可能的原因：
- 页面更新需要时间，等待时间不够
- 账号按钮的 HTML 结构已更改
- 网络延迟导致页面加载慢

**解决方案**：
- 增加等待时间（步骤 5）
- 更新选择器（步骤 6）
- 检查网络连接

---

### Q2: 为什么找不到可用账号？

**A**: 可能的原因：
- 所有账号都已使用（达到 rate limit）
- 账号提取方法失效
- 页面结构已更改

**解决方案**：
- 重启程序清空记录
- 手动选择账号（步骤 7）
- 更新选择器（步骤 6）

---

### Q3: 如何确认账号切换成功？

**A**: 检查以下几点：
- 日志显示 "✅ 账号切换成功: 旧账号 → 新账号"
- 截图显示新账号
- 后续请求没有 rate limit 错误

---

### Q4: 可以跳过账号切换吗？

**A**: 可以，但不推荐：

```python
# 在 wait_for_response() 方法中
# 注释掉账号切换逻辑
# if self.check_rate_limit():
#     ...
```

**后果**：
- 遇到 rate limit 会停止
- 需要手动处理
- 无法批量处理

---

## 11. 最佳实践

### 建议配置：

```python
# config.py

# 使用系统 Chrome（保持登录状态）
USE_SYSTEM_CHROME = True

# 启用用户确认（仅首次）
WAIT_USER_CONFIRMATION = True

# 启用截图（便于调试）
SAVE_SCREENSHOTS = True

# 调试模式（开发时启用）
DEBUG_MODE = False
LOG_LEVEL = "INFO"  # 正常使用 INFO，调试时用 DEBUG
```

### 使用建议：

1. **首次运行**：
   - 使用 `LOG_LEVEL = "DEBUG"`
   - 观察日志输出
   - 确认账号识别正常

2. **正常使用**：
   - 使用 `LOG_LEVEL = "INFO"`
   - 减少日志输出
   - 提高性能

3. **遇到问题**：
   - 切换到 `DEBUG` 模式
   - 查看详细日志
   - 检查截图

---

## 12. 版本历史

### v1.6.3（当前版本）
- ✅ 修复账号识别问题
- ✅ 增加多种提取方法
- ✅ 添加切换后验证
- ✅ 详细的调试日志

### v1.6.2
- ✅ 切换后跳过确认
- ✅ 提高自动化程度

### v1.6.1
- ✅ 切换后重新开始
- ✅ 重新上传视频

### v1.6.0
- ✅ 自动账号切换
- ✅ Rate limit 检测

---

**祝使用愉快！如有问题，请参考本指南或联系支持。**
