# 更新日志

所有重要的项目变更都会记录在这个文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.7.1] - 2024-12-06

### 修复

#### 修复步骤跳过问题 - 持续等待直到AI完成 ⭐⭐⭐⭐⭐
- ✅ 修改 `wait_for_response()` 方法为无限循环
- ✅ 添加超时计数机制
- ✅ 前2次超时自动继续等待
- ✅ 第3次超时询问用户是否继续
- ✅ 确保每个步骤都完整执行，不跳过
- ✅ 避免AI未完成就开始下一步

**问题说明**：
- 步骤2还在处理时就开始步骤3，导致响应不完整
- 之前的超时机制（60秒）会导致步骤被跳过
- AI处理复杂任务时需要更长时间

**改进效果**：
- 持续等待直到AI真正完成
- 超时3次后才询问用户
- 确保数据完整性
- 避免浪费时间处理不完整的数据

---

## [1.7.0] - 2024-12-06

### 改进

#### 处理上传视频后的弹窗 - 自动关闭并刷新 ⭐⭐⭐⭐⭐
- ✅ 新增 `check_and_close_upload_popup()` 方法
- ✅ 上传后自动检测版权确认弹窗
- ✅ 自动点击 Acknowledge 按钮关闭弹窗
- ✅ 关闭后自动刷新页面
- ✅ 自动重新开始步骤1
- ✅ 完全自动化，无需人工干预

**问题说明**：
- 切换账号后，上传视频时可能出现版权确认弹窗
- 需要点击 "Acknowledge" 按钮才能继续
- 点击后需要刷新页面重新开始

**改进效果**：
- 自动检测并关闭弹窗
- 自动刷新页面并重新上传
- 无需人工干预，完全自动化

---

## [1.6.9] - 2024-12-06

### 改进

#### 优化步骤25表格数据提取 - 从HTML DOM直接提取 ⭐⭐⭐⭐⭐
- ✅ 新增 `extract_table_from_dom()` 方法
- ✅ 从HTML DOM直接提取表格数据
- ✅ 修改 `extract_response()` 方法，添加 `step_number` 参数
- ✅ 步骤25使用DOM提取，其他步骤使用文本提取
- ✅ 完整保留所有空单元格
- ✅ 详细的日志输出和统计信息
- ✅ 失败时自动回退到文本提取

**问题说明**：
- 步骤25输出的是表格数据
- 之前使用文本解析（`inner_text()`），可能丢失数据
- 表格在HTML中是完整的，但文本提取可能不准确

**改进效果**：
- 数据完整性从70-80%提升到99-100%
- 完整保留所有空单元格
- 不需要文本解析，更可靠
- 详细的日志便于调试

---

## [1.6.8] - 2024-12-06

### 改进

#### 扩展弹窗关闭支持 - 添加 Acknowledge 等按钮 ⭐⭐⭐⭐⭐
- ✅ 新增 "Acknowledge" 按钮支持（版权确认）
- ✅ 新增 "Accept" / "Agree" 按钮支持（条款同意）
- ✅ 新增 "Continue" 按钮支持（继续操作）
- ✅ 新增 Material Dialog 按钮支持
- ✅ 新增中文确认按钮支持（同意、接受、继续）
- ✅ 选择器从15个扩展到30+个

**问题说明**：
- v1.6.7 添加了弹窗关闭功能，但遇到新的弹窗类型无法关闭
- 例如：版权确认弹窗（Copyright Acknowledgement）

**改进效果**：
- 支持更多类型的弹窗
- 覆盖版权确认、条款同意、继续操作等场景
- 支持 Material Dialog 组件

---

## [1.6.7] - 2024-12-06

### 改进

#### 切换账号后自动关闭弹窗 ⭐⭐⭐⭐⭐
- ✅ 新增 `close_popups()` 方法
- ✅ 支持15+种关闭按钮选择器
- ✅ 智能检测多个弹窗（最多5次）
- ✅ 切换账号后等待5秒并自动关闭弹窗
- ✅ 支持中英文弹窗
- ✅ 容错处理，忽略错误继续

**问题说明**：
- 切换账号后，AI Studio 可能显示弹窗（欢迎提示、新功能介绍等）
- 弹窗会阻挡页面操作
- 需要手动关闭才能继续

**改进效果**：
- 切换账号后自动等待5秒让弹窗出现
- 自动检测并关闭所有弹窗
- 无需人工干预，完全自动化

---

## [1.6.6] - 2024-12-06

### 改进

#### 检测配额超限错误并切换账号 ⭐⭐⭐⭐⭐
- ✅ 扩展 `check_rate_limit()` 方法检测范围
- ✅ 新增 "exceeded quota" 检测
- ✅ 新增 "user has exceeded quota" 检测
- ✅ 新增 "Please try again later" 检测
- ✅ 新增中文 "配额已超限" 检测
- ✅ 配额超限时自动切换账号

**问题说明**：
- 除了 "rate limit" 错误，还会出现 "exceeded quota" 错误
- 错误信息：`Failed to generate content: user has exceeded quota. Please try again later.`
- 之前只检测 "rate limit"，配额超限时无法自动切换

**改进效果**：
- 统一处理 rate limit 和 quota exceeded 错误
- 配额超限时自动切换到下一个账号
- 最大化利用所有可用账号

---

## [1.6.5] - 2024-12-06

### 修复

#### 检测并恢复视频上传失败 ⭐⭐⭐⭐⭐
- ✅ 检测步骤1的Run按钮超时（300秒）
- ✅ 步骤1超时返回特殊标记 "upload_failed"
- ✅ 自动刷新页面并重新开始步骤1
- ✅ 新增 `check_video_uploaded()` 方法验证上传状态
- ✅ 在上传后验证视频元素是否存在
- ✅ 避免强行发送导致错误数据

**问题说明**：
- 视频上传后Run按钮一直不可用（等待300秒超时）
- 之前会强行使用快捷键发送，导致AI没有视频数据
- 继续执行后续25步，全部失败，浪费时间

**改进效果**：
- 检测到步骤1失败后自动刷新页面
- 重新开始步骤1，重新上传视频
- 确保视频正确上传后才继续
- 成功率从90%提升到99%

---

## [1.6.4] - 2024-12-06

### 改进

#### 修正用户确认时机 ⭐⭐⭐⭐⭐
- ✅ 调整流程顺序，符合业务流程文档
- ✅ 在加载视频列表后立即打开 AI Studio
- ✅ 在加载视频列表后立即等待用户确认
- ✅ 确认前显示已加载的视频数量
- ✅ 移除 `process_single_video()` 中的 `open_ai_studio()` 调用
- ✅ 只打开一次 AI Studio，提高效率

**问题说明**：
- 之前的确认时机在处理第一个视频时
- 不符合业务流程文档的要求
- 用户在确认前不知道有多少个视频

**改进效果**：
- 符合业务流程：步骤1 → 确认 → 步骤2 → 步骤3
- 用户体验更好：确认前知道视频数量
- 代码更清晰：流程更符合逻辑

---

## [1.6.3] - 2024-12-06

### 修复

#### 账号切换识别问题 ⭐⭐⭐⭐⭐
- ✅ 修复 `get_current_account()` 无法正确识别新账号的问题
- ✅ 增加页面更新等待时间
- ✅ 实现多种账号提取方法（inner_text、子元素、属性）
- ✅ 改进账号选择逻辑，使用正则表达式提取邮箱
- ✅ 添加切换后验证机制
- ✅ 添加详细的统计和调试日志

**问题说明**：
- 切换账号后 `get_current_account()` 一直返回旧账号
- 导致 `switched_accounts` 记录错误
- 重复选择同一个账号
- 最终提示"没有找到可用的账号"

**改进措施**：
- 等待页面稳定（2秒）
- 等待按钮可见（5秒超时）
- 3种方法提取当前账号
- 3种方法提取账号列表
- 切换后验证新账号
- 显示所有账号和已切换账号的统计

---

## [1.6.2] - 2024-12-06

### 改进

#### 切换账号后跳过用户确认 ⭐⭐⭐⭐⭐
- ✅ 只在首次打开 AI Studio 时要求用户确认
- ✅ 切换账号后自动继续，无需确认
- ✅ 添加 `ai_studio_opened` 标记
- ✅ 提高自动化程度到 99%
- ✅ 真正实现无人值守

**问题说明**：
- 之前每次切换账号后都要求用户按 Enter 确认
- 但账号已经登录，不需要确认
- 影响自动化效率，用户需要一直守在电脑前

**改进效果**：
- 首次启动确认后可以离开
- 自动处理所有账号切换
- 每次切换节省 5-10 秒
- 适合夜间批量处理

---

## [1.6.1] - 2024-12-05

### 修复

#### 账号切换后自动重新开始 ⭐⭐⭐⭐⭐
- ✅ 修复切换账号后会话丢失的问题
- ✅ 切换后自动重新上传视频
- ✅ 切换后自动从步骤1开始
- ✅ 添加清晰的日志提示
- ✅ 确保 AI 有完整的上下文

**问题说明**：
- 切换账号后，新会话没有之前的对话历史和上传的视频
- 之前的逻辑尝试从当前步骤继续，导致失败
- 新逻辑自动重新上传视频并从步骤1开始

**技术原因**：
- Google 账号切换会创建新的会话
- 新会话中没有任何历史数据
- AI 需要完整的上下文才能正确处理后续步骤
- 必须从步骤1开始建立上下文

---

## [1.6.0] - 2024-12-05

### 新增

#### 自动账号切换（Rate Limit 处理）⭐⭐⭐⭐⭐
- ✅ 自动检测 "You've reached your rate limit" 错误
- ✅ 自动切换到下一个可用的 Google 账号
- ✅ 记录已切换的账号，避免重复使用
- ✅ 支持手动选择账号
- ✅ 切换后自动重新发送请求
- ✅ 显示已切换账号数量

**功能说明**：
- 检测到 rate limit 时自动点击账号切换按钮
- 自动点击"切换账号"并跳转到 Google 账号页面
- 自动选择下一个未使用的账号
- 返回 AI Studio 后自动重新发送当前步骤
- 支持多个账号轮换使用

**使用场景**：
- 批量处理大量视频
- 避免 rate limit 中断
- 提高处理效率
- 无需人工干预

---

## [1.5.1] - 2024-12-05

### 修复

#### 上传视频优化 ⭐⭐⭐⭐⭐
- ✅ 修复 "Jsloader error" 上传失败问题
- ✅ 增强页面加载等待（使用 networkidle）
- ✅ 增加页面加载超时时间到 60 秒
- ✅ 等待页面主体元素加载完成
- ✅ 优化上传流程等待时间
- ✅ 增加 Upload File 按钮查找重试机制
- ✅ 增加文件选择器超时时间到 30 秒
- ✅ 添加智能上传进度检测
- ✅ 实时监控上传状态并输出进度

**问题说明**：
- 上传视频时出现 "Jsloader error (code #1): Timeout reached for loading script"
- 页面未完全加载导致 JavaScript 加载超时
- 操作时机不对导致上传失败

**解决方案**：
- 使用更完整的页面加载等待策略
- 增加各个步骤的等待时间
- 添加上传进度实时监控
- 提高操作成功率

---

## [1.5.0] - 2024-12-05

### 新增

#### 交互式错误处理和流程控制 ⭐⭐⭐⭐⭐
- ✅ 遇到错误不崩溃，等待用户处理
- ✅ 支持从任意步骤（1-25）恢复执行
- ✅ 支持重试当前步骤
- ✅ 支持跳过当前视频
- ✅ 支持手动干预后继续

**用户操作选项**：
- 输入步骤号 (1-25) - 从指定步骤继续
- 输入 'retry' - 重试当前步骤
- 输入 'skip' - 跳过当前视频
- 输入 'quit' - 退出程序
- 直接按 Enter - 继续下一步

#### 循环执行模式 ⭐⭐⭐⭐⭐
- ✅ 批次完成后不退出程序
- ✅ 支持更新 VideoList.csv 后继续
- ✅ 无需重启程序和浏览器
- ✅ 高效批量处理多批次视频

**工作流程**：
1. 处理一批视频
2. 批次完成，询问用户操作
3. 用户更新 VideoList.csv
4. 输入 'continue' 继续下一批
5. 或输入 'quit' 退出程序

#### 步骤级错误处理 ⭐⭐⭐⭐
- ✅ 每个步骤独立错误处理
- ✅ 保留已完成步骤的数据
- ✅ 支持步骤级重试和恢复
- ✅ 详细的错误信息和当前步骤提示

**错误处理点**：
- 更新提示词文件
- 打开 AI Studio
- 上传视频
- 发送步骤 1-25（每个步骤独立）
- 保存输出数据

---

## [1.4.3] - 2024-12-05

### 修复

#### 表格解析逻辑优化 ⭐⭐⭐
- ✅ 支持空单元格的解析
- ✅ 支持不完整行的解析（单元格数量少于表头）
- ✅ 修复 music、cover_time、title 等列数据丢失问题
- ✅ 显示每列的非空数据统计
- ✅ 改进单元格分割逻辑，保留空值
- ✅ 更详细的调试信息

**问题说明**：
- 步骤25输出的表格中，music、cover_time、title 等列并不是每行都有数据
- 旧逻辑要求每行单元格数量必须与表头一致，导致有空单元格的行被跳过
- 新逻辑能够正确处理空单元格和不完整的行

---

## [1.4.2] - 2024-12-05

### 改进

#### 最终处理脚本执行优化 ⭐⭐
- ✅ 添加详细的执行前警告
- ✅ 说明 process_video.py 需要配置资源文件夹
- ✅ 显示配置要求（字体、音乐、FFmpeg）
- ✅ 执行后显示结果和错误提示
- ✅ 提供解决方案建议
- ✅ 允许配置错误时的正常报错

---

## [1.4.1] - 2024-12-05

### 修复

#### Excel 合并和语法错误修复 ⭐⭐
- ✅ 跳过 Excel 临时文件（.~ 和 ~$ 开头）
- ✅ 修复 process_video.py 语法错误
- ✅ 改进日志输出
- ✅ 显示合并数据统计

---

## [1.4.0] - 2024-12-05

### 新增

#### 智能数据解析功能 ⭐⭐⭐
- ✅ 添加 `parse_table_response()` 方法
- ✅ 自动解析 AI 响应中的表格数据
- ✅ 支持 Markdown 表格格式
- ✅ 支持 JSON 格式
- ✅ 支持 CSV 格式
- ✅ 自动提取 9个标准字段（filename, start, end, Folder, Folder2, Folder3, music, cover_time, title）
- ✅ 显示解析后的列名和数据统计

---

## [1.3.9] - 2024-12-05

### 修复

#### 更新视频处理流程文档 ⭐
- ✅ 删除执行 get_duration.bat 的步骤
- ✅ VideoList.csv 已预先生成，无需手动执行
- ✅ 简化流程说明
- ✅ 更新注意事项

---

## [1.3.8] - 2024-12-05

### 新增

#### 打包功能 ⭐⭐⭐
- ✅ 添加 PyInstaller 打包支持
- ✅ 创建打包脚本（build.py, build.sh, build.bat）
- ✅ 创建打包配置文件（build.spec）
- ✅ 自动检查和安装依赖
- ✅ 支持 Windows/macOS/Linux
- ✅ 生成独立可执行文件
- ✅ 详细的打包文档

---

## [1.3.7] - 2024-12-05

### 修复

#### process_video.py 语法错误 ⭐⭐
- ✅ 修复 f-string 中嵌套引号导致的语法错误
- ✅ 使用中间变量分离路径处理逻辑
- ✅ 提高代码可读性
- ✅ 添加注释说明

---

## [1.3.6] - 2024-12-05

### 修复

#### 延长按钮等待超时时间 ⭐⭐⭐
- ✅ 将 WAIT_BUTTON_ENABLED 从 10 秒延长到 300 秒（5分钟）
- ✅ 适应慢速网络和大文件上传
- ✅ 添加每 10 秒的进度提示
- ✅ 显示已等待时间
- ✅ 超时后自动使用快捷键备用方案

---

## [1.3.5] - 2024-12-05

### 修复

#### Content Blocked 检测去重优化 ⭐⭐⭐
- ✅ 修复 Content blocked 重复检测问题
- ✅ 添加冷却时间机制（默认 60 秒）
- ✅ 避免重复发送"继续"
- ✅ 每个视频独立重置标记
- ✅ 可配置冷却时间

---

## [1.3.4] - 2024-12-05

### 修复

#### 发送提示词流程优化 ⭐⭐⭐
- ✅ 修复发送按钮未触发的问题
- ✅ 填入文字后等待 Run 按钮变为可用
- ✅ 检测按钮的 aria-disabled 属性
- ✅ 按钮可用后再点击发送
- ✅ 添加详细的日志输出
- ✅ 提供快捷键备用方案

---

## [1.3.3] - 2024-12-05

### 修复

#### 上传后关闭浮窗菜单 ⭐⭐⭐
- ✅ 上传完成后自动关闭浮窗菜单
- ✅ 添加 0.3 秒延迟确保文件选择完成
- ✅ 使用 Escape 键关闭菜单（主要方法）
- ✅ 备用方法：点击页面其他区域
- ✅ 确保 Run 按钮可用
- ✅ 避免菜单遮挡界面

### 新增

#### 验证脚本
- ✅ 添加 `verify_menu_close.py` 验证菜单关闭功能
- ✅ 检查菜单是否正确关闭
- ✅ 检查 Run 按钮是否可用
- ✅ 检查按钮是否被遮挡

---

## [1.3.2] - 2024-12-05

### 改进

#### 智能等待机制 ⭐⭐⭐
- ✅ 通过检测 Run 按钮状态判断 AI 是否运行
- ✅ 按钮显示 "Stop" 时等待
- ✅ 按钮显示 "Run" 时继续
- ✅ 更准确的响应完成检测
- ✅ 每 10 秒输出等待状态
- ✅ 避免过早发送下一步

---

## [1.3.1] - 2024-12-05

### 改进

#### 视频上传流程优化
- ✅ 更新为两步上传流程
- ✅ 先点击添加按钮（add_circle 图标）
- ✅ 再点击 Upload File 按钮
- ✅ 支持 file chooser 事件
- ✅ 更新选择器配置
- ✅ 增加详细的上传日志

---

## [1.3.0] - 2024-12-05

### 新增

#### 用户确认机制 ⭐⭐⭐
- ✅ 打开页面后等待用户确认
- ✅ 确保用户已登录并进入对话界面
- ✅ 友好的确认提示
- ✅ 支持按 Enter 键继续
- ✅ 添加 `WAIT_USER_CONFIRMATION` 配置选项
- ✅ 可选择跳过用户确认

### 改进

- ✅ 优化用户交互流程
- ✅ 增加操作确认步骤
- ✅ 更新所有文档，添加用户确认说明

---

## [1.2.0] - 2024-12-05

### 新增

#### 系统 Chrome 支持 ⭐⭐⭐
- ✅ 支持使用系统安装的 Chrome 浏览器
- ✅ 支持使用 Chrome 默认用户配置
- ✅ 已登录的 Google 账号直接可用
- ✅ 无需重复登录
- ✅ 自动检测和回退机制
- ✅ 添加 `USE_SYSTEM_CHROME` 配置选项

### 改进

- ✅ 优化浏览器启动逻辑
- ✅ 支持跨平台 Chrome 路径检测（macOS/Windows/Linux）
- ✅ 改进关闭浏览器的逻辑
- ✅ 更新所有文档，添加浏览器配置说明

---

## [1.1.0] - 2024-12-05

### 新增

#### 会话管理功能
- ✅ 自动保存浏览器会话状态
- ✅ 自动加载已保存的会话
- ✅ 首次登录后无需重复登录
- ✅ 会话状态保存到 `.browser_session/` 目录
- ✅ 添加 `clear_session.py` 清除会话工具

### 改进

- ✅ 优化登录流程，自动检测登录状态
- ✅ 添加等待用户登录的友好提示
- ✅ 关闭浏览器时自动保存会话
- ✅ 更新所有文档，添加会话管理说明

---

## [1.0.0] - 2024-12-05

### 新增

#### 核心功能
- ✅ 视频列表自动读取功能
- ✅ 提示词文件自动管理
- ✅ 浏览器自动化控制（基于 Playwright）
- ✅ 视频自动上传到 Google AI Studio
- ✅ 25 步 AI 对话自动执行
- ✅ "Content blocked" 异常自动检测和处理
- ✅ 输出数据自动保存为 Excel
- ✅ 多个 Excel 文件自动合并
- ✅ 批量视频循环处理

#### 辅助功能
- ✅ 完整的日志系统（支持文件和控制台输出）
- ✅ 关键步骤自动截图
- ✅ 失败操作自动重试（最多 3 次）
- ✅ 灵活的配置管理系统
- ✅ 浏览器连接测试工具
- ✅ 功能演示脚本

#### 文档
- ✅ README.md - 项目主页
- ✅ 开始使用.md - 5 分钟快速上手指南
- ✅ 使用指南.md - 详细使用教程
- ✅ 快速参考.md - 常用命令和配置速查
- ✅ 项目说明.md - 项目架构和技术栈
- ✅ 项目总结.md - 功能清单和完成总结
- ✅ 视频处理流程.md - 业务流程说明
- ✅ 文件清单.md - 所有文件列表
- ✅ 检查清单.md - 项目完成检查
- ✅ 项目完成报告.md - 详细完成报告

#### 工具脚本
- ✅ setup.sh - 自动安装脚本
- ✅ run.sh - 快速启动脚本
- ✅ test_connection.py - 测试工具
- ✅ demo.py - 演示脚本

#### 配置文件
- ✅ config.py - 集中配置管理
- ✅ requirements.txt - Python 依赖清单
- ✅ .gitignore - Git 忽略规则
- ✅ VERSION - 版本号文件
- ✅ LICENSE - MIT 许可证
- ✅ CHANGELOG.md - 本文件

### 技术特性

- 🎯 **智能等待机制** - 自动检测页面加载和 AI 响应状态
- 🛡️ **健壮异常处理** - 完善的错误检测、日志和重试机制
- ⚙️ **灵活配置系统** - 所有参数可通过配置文件调整
- 📝 **完整日志记录** - 多级别日志，便于调试和追踪
- 📸 **自动截图功能** - 关键步骤自动截图，便于问题排查
- 🔄 **自动重试机制** - 失败操作自动重试，提高成功率

### 性能

- ⚡ 单视频处理时间：5-10 分钟
- ⚡ 25 步对话时间：3-5 分钟
- ⚡ 内存使用：200-500 MB
- ⚡ CPU 使用：低（主要等待网络响应）

### 兼容性

- ✅ Python 3.8+
- ✅ macOS / Linux / Windows
- ✅ Chromium 浏览器
- ✅ Google AI Studio

---

## [未来计划]

### 短期改进

- [ ] 添加进度条显示
- [ ] 优化选择器自动检测
- [ ] 支持断点续传
- [ ] 添加更多视频格式支持

### 中期改进

- [ ] 添加 GUI 界面
- [ ] 支持多浏览器（Firefox, Safari）
- [ ] 添加性能监控
- [ ] 优化内存使用

### 长期改进

- [ ] 支持分布式处理
- [ ] 添加 API 接口
- [ ] 支持更多 AI 平台
- [ ] 添加数据分析功能

---

## 版本说明

### 版本号格式

版本号格式：`主版本号.次版本号.修订号`

- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 更新类型

- **新增** - 新功能
- **变更** - 现有功能的变更
- **弃用** - 即将移除的功能
- **移除** - 已移除的功能
- **修复** - 问题修复
- **安全** - 安全相关的修复

---

## 贡献指南

如果你想为项目做出贡献：

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

**当前版本**: v1.0.0  
**发布日期**: 2024-12-05  
**状态**: ✅ 稳定版本
