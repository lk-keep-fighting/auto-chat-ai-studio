# 📤 视频上传流程说明

## 问题说明

在实现视频上传功能时，需要正确处理文件选择对话框。

---

## 🎯 正确的实现方式

### Playwright File Chooser

**关键点**：必须在点击按钮**之前**设置 file chooser 监听器。

### 正确代码

```python
# ✅ 正确：先设置监听器，再点击按钮
with page.expect_file_chooser() as fc_info:
    upload_file_button.click()  # 点击触发文件选择对话框

file_chooser = fc_info.value
file_chooser.set_files(video_path)  # 自动选择文件
```

### 错误代码

```python
# ❌ 错误：先点击按钮，再设置监听器
upload_file_button.click()  # 已经触发了对话框

with page.expect_file_chooser() as fc_info:  # 太晚了
    pass
```

---

## 📝 完整流程

### 步骤1：点击添加按钮

```python
# 查找并点击添加按钮
add_button = page.locator('button[iconname="add_circle"]')
add_button.click()
time.sleep(1)  # 等待菜单显示
```

### 步骤2：点击 Upload File（使用 file chooser）

```python
# 查找 Upload File 按钮
upload_file_button = page.locator('button[aria-label="Upload File"]')

# 设置 file chooser 监听器，然后点击
with page.expect_file_chooser() as fc_info:
    upload_file_button.click()  # 这会触发文件选择对话框

# 获取 file chooser 并设置文件
file_chooser = fc_info.value
file_chooser.set_files(video_path)
```

### 步骤3：关闭浮窗菜单 ⭐

```python
# 关闭浮窗菜单（重要！）
time.sleep(0.3)  # 等待文件选择完成
page.keyboard.press("Escape")
time.sleep(0.5)
```

**关键步骤**：
- ⚠️ 必须关闭菜单，否则 Run 按钮不可用
- 等待 0.3 秒确保文件选择完成
- 使用 Escape 键是最可靠的方法
- 也可以点击页面其他区域关闭

### 步骤3：关闭浮窗菜单

```python
# 关闭浮窗菜单（重要！）
time.sleep(0.3)  # 等待文件选择完成
page.keyboard.press("Escape")
time.sleep(0.5)
```

**为什么要关闭菜单？**
- 点击添加按钮后会显示浮窗菜单
- 如果不关闭，菜单会遮挡 Run 按钮
- Run 按钮会处于不可用状态
- 无法继续下一步操作

### 步骤4：等待上传完成

```python
# 等待上传完成
time.sleep(15)  # 根据文件大小调整
```

---

## 🔍 工作原理

### File Chooser 事件

1. **设置监听器**
   ```python
   with page.expect_file_chooser() as fc_info:
   ```
   - 告诉 Playwright：我要处理文件选择对话框
   - 监听器会捕获接下来触发的文件选择事件

2. **触发对话框**
   ```python
   upload_file_button.click()
   ```
   - 点击按钮触发文件选择对话框
   - Playwright 拦截对话框，不显示给用户

3. **自动选择文件**
   ```python
   file_chooser = fc_info.value
   file_chooser.set_files(video_path)
   ```
   - 获取 file chooser 对象
   - 自动设置要上传的文件
   - 无需用户手动选择

---

## 🎬 用户视角

### 手动操作

如果用户手动操作，流程是：
1. 点击添加按钮
2. 点击 "Upload File"
3. **文件选择对话框弹出**
4. **用户选择文件**
5. 文件开始上传

### 自动化操作

使用 Playwright 自动化：
1. 点击添加按钮
2. 设置 file chooser 监听器
3. 点击 "Upload File"
4. **Playwright 拦截对话框**
5. **自动选择文件**
6. 文件开始上传

**关键**：用户看不到文件选择对话框，因为 Playwright 自动处理了。

---

## 🧪 测试方法

### 运行测试脚本

```bash
python test_upload.py
```

### 测试步骤

1. 脚本打开浏览器
2. 访问 AI Studio
3. 等待你登录并进入对话界面
4. 按 Enter 开始测试
5. 自动执行上传流程
6. 查看结果

### 预期结果

```
🧪 测试视频上传流程
============================================================
1️⃣ 启动浏览器...
2️⃣ 访问 AI Studio...

============================================================
请在浏览器中完成以下操作：
1. 登录 Google 账号（如需要）
2. 进入对话界面
============================================================

按 Enter 继续测试上传流程...

3️⃣ 开始测试上传流程...
   a) 查找添加按钮...
   ✅ 找到添加按钮
   ✅ 已点击添加按钮
   b) 查找 Upload File 按钮...
   ✅ 找到 Upload File 按钮
   c) 测试 file chooser...
   📁 测试文件: test.mp4
   🔄 使用 file chooser 方法...
   ✅ 已点击 Upload File 按钮
   ✅ 已选择文件: test.mp4
   
   ⏳ 等待上传...
   ✅ 上传流程完成

✅ 测试完成！
```

---

## 🐛 常见问题

### Q1: 为什么看不到文件选择对话框？

**A**: 这是正常的！Playwright 的 file chooser 会拦截对话框，自动选择文件。

### Q2: 如何确认文件已选择？

**A**: 
1. 查看日志输出
2. 查看页面上是否显示文件名
3. 查看截图

### Q3: 如果 file chooser 失败怎么办？

**A**: 代码中有备用方法：
```python
try:
    # 方法1：file chooser
    with page.expect_file_chooser() as fc_info:
        upload_file_button.click()
    file_chooser = fc_info.value
    file_chooser.set_files(video_path)
except:
    # 方法2：直接设置 input 元素
    file_input = page.locator('input[type="file"]')
    file_input.set_input_files(video_path)
```

---

## 📊 日志输出

### 成功上传

```
📤 正在上传视频: video.mp4
1️⃣ 点击添加按钮...
✅ 已点击添加按钮
2️⃣ 点击 Upload File 按钮...
3️⃣ 设置文件选择器并上传文件...
✅ 已点击 Upload File 按钮
✅ 已选择文件: video.mp4
4️⃣ 关闭浮窗菜单...
✅ 已按 Escape 键关闭菜单
⏳ 等待视频上传完成...
✅ 视频上传完成
```

### 失败回退

```
📤 正在上传视频: video.mp4
1️⃣ 点击添加按钮...
✅ 已点击添加按钮
2️⃣ 点击 Upload File 按钮...
3️⃣ 设置文件选择器并上传文件...
⚠️ file chooser 方法失败: xxx
尝试直接设置 input 元素...
✅ 已选择文件: video.mp4
⏳ 等待视频上传完成...
✅ 视频上传完成
```

---

## 💡 最佳实践

### 1. 使用 file chooser（推荐）

```python
with page.expect_file_chooser() as fc_info:
    button.click()
file_chooser = fc_info.value
file_chooser.set_files(path)
```

**优点**：
- ✅ 标准方法
- ✅ 可靠性高
- ✅ 跨平台兼容

### 2. 直接设置 input（备用）

```python
file_input = page.locator('input[type="file"]')
file_input.set_input_files(path)
```

**优点**：
- ✅ 简单直接
- ✅ 不需要点击

**缺点**：
- ❌ 可能找不到 input
- ❌ input 可能被隐藏

### 3. 组合使用（最佳）

```python
try:
    # 优先使用 file chooser
    with page.expect_file_chooser() as fc_info:
        button.click()
    file_chooser = fc_info.value
    file_chooser.set_files(path)
except:
    # 失败时使用 input
    file_input = page.locator('input[type="file"]')
    file_input.set_input_files(path)
```

---

## 🎉 总结

**关键点**：
1. ✅ 使用 `expect_file_chooser()` 在点击前设置监听器
2. ✅ 在 `with` 块内点击按钮
3. ✅ 获取 file chooser 并设置文件
4. ✅ 用户看不到文件选择对话框（自动处理）
5. ✅ 提供备用方法以提高可靠性

---

**更新日期**: 2024-12-05  
**版本**: v1.3.2
